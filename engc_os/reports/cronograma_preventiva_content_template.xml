<?xml version='1.0' encoding='utf-8'?>
<odoo>
    <!-- Template interno do cronograma de preventiva (sem wrappers) -->
    <!-- Este template contém apenas o conteúdo do cronograma, sem web.html_container e web.external_layout -->
    <!-- Pode ser chamado tanto pelo report principal quanto pelo wizard -->
    <template id="report_cronograma_preventiva_content">
        <t t-foreach="docs" t-as="o">
            <style type="text/css">
                .table-borderless > :not(caption) > * > * {
                    border: 0;
                    border-bottom-width: 0px;
                }
                .table > :not(caption) > * > * {
                    padding: 0.1rem 0.1rem;
                    border-bottom-width: 0px;
                }
                .table > tbody {
                    vertical-align: inherit;
                }
                .table > thead {
                    vertical-align: bottom;
                }
                .table > :not(:first-child) {
                    border-top: 2px solid currentColor;
                }
                .calendar-day {
                    text-align: center;
                    min-width: 25px;
                    padding: 2px !important;
                }
                .calendar-day.programmed {
                    background-color: #d3d3d3;
                    font-weight: bold;
                }
                .calendar-day.empty {
                    color: #ffffff;
                }
                .equipment-col {
                    width: 250px;
                    font-size: 0.85em;
                }
                .week-header {
                    text-align: center;
                    font-weight: bold;
                    background-color: #f8f9fa;
                }
                .day-header {
                    text-align: center;
                    font-weight: bold;
                    font-size: 0.9em;
                }
                .month-title {
                    text-align: center;
                    font-weight: bold;
                    font-size: 1.2em;
                    margin: 20px 0 10px 0;
                    page-break-after: avoid;
                }
            </style>
            <div class="page">
                <!-- Cabeçalho do relatório -->
                <div class="row mb-3">
                    <div class="col-12 text-center">
                        <h1><t t-esc="o.get_year_from_cronograma()"/> - CRONOGRAMA DE PREVENTIVA </h1>
                        <h2><span t-field="o.company_id.name"/></h2>
                        <h3><span t-field="o.name"/></h3> 
                    </div>
                </div>

                <!-- Loop pelos meses do ano -->
                <t t-set="ano" t-value="o.get_year_from_cronograma()"/>
                <t t-foreach="[1,2,3,4,5,6,7,8,9,10,11,12]" t-as="mes_num">
                    <t t-set="mes_nome" t-value="o.meses_nome[mes_num - 1]"/>
                    <t t-set="programmed_days" t-value="o.get_programmed_days_by_equipment_month(ano, mes_num)"/>
                    <t t-set="calendar_weeks" t-value="o.get_calendar_month_filtered(ano, mes_num)"/>
                    
                    <!-- Título do mês -->
                    <div class="month-title">
                        <t t-esc="mes_nome"/>
                    </div>
                    
                    <!-- Tabela do mês -->
                    <table class="table table-sm table-bordered" style="font-size: 0.75em;">
                        <thead>
                            <tr>
                                <th class="equipment-col">Equipamentos</th>
                                <t t-set="week_count" t-value="0"/>
                                <t t-foreach="calendar_weeks" t-as="week">
                                    <t t-set="week_count" t-value="week_count + 1"/>
                                    <t t-set="week_days_count" t-value="len(week)"/>
                                    <th t-att-colspan="week_days_count" class="week-header">
                                        Semana <t t-esc="week_count"/>
                                    </th>
                                </t>
                            </tr>
                            <tr>
                                <th class="equipment-col"></th>
                                <t t-foreach="calendar_weeks" t-as="week">
                                    <t t-foreach="week" t-as="day_info">
                                        <t t-if="day_info">
                                            <t t-set="dia_semana_idx" t-value="day_info[1]"/>
                                            <t t-set="dia_semana_letras" t-value="['S','T','Q','Q','S','S','D']"/>
                                            <th class="day-header"><t t-esc="dia_semana_letras[dia_semana_idx]"/></th>
                                        </t>
                                        <t t-else="">
                                            <th class="day-header"></th>
                                        </t>
                                    </t>
                                </t>
                            </tr>
                            <tr>
                                <th class="equipment-col"></th>
                                <t t-foreach="calendar_weeks" t-as="week">
                                    <t t-foreach="week" t-as="day_info">
                                        <t t-if="day_info">
                                            <t t-set="day" t-value="day_info[0]"/>
                                            <th class="calendar-day">
                                                <t t-esc="day"/>
                                            </th>
                                        </t>
                                        <t t-else="">
                                            <th class="calendar-day"></th>
                                        </t>
                                    </t>
                                </t>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loop pelos equipamentos -->
                            <t t-set="sorted_equipments" t-value="o.equipments.sorted('name')"/>
                            <t t-foreach="sorted_equipments" t-as="equipment">
                                <tr>
                                    <td class="equipment-col">
                                        <span t-field="equipment.name"/>
                                    </td>
                                    <t t-foreach="calendar_weeks" t-as="week">
                                        <t t-foreach="week" t-as="day_info">
                                            <t t-if="day_info">
                                                <t t-set="day" t-value="day_info[0]"/>
                                                <t t-set="equipment_id" t-value="equipment.id"/>
                                                <t t-set="equipment_days" t-value="programmed_days.get(equipment_id, [])"/>
                                                <t t-set="is_programmed" t-value="equipment_id in programmed_days and day in equipment_days"/>
                                                <td class="calendar-day" t-att-class="'programmed' if is_programmed else ''">
                                                    <t t-if="is_programmed">
                                                        <strong style="font-size: 1.2em;">X</strong>
                                                    </t>
                                                </td>
                                            </t>
                                            <t t-else="">
                                                <td class="calendar-day"></td>
                                            </t>
                                        </t>
                                    </t>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                    
                    <!-- Espaçamento entre meses -->
                    <div style="margin-bottom: 30px;"></div>
                </t>
            </div>
        </t>
    </template>
</odoo>
