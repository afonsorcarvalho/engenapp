<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_relatorio_atendimento_resumo_template">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <style type="text/css">
                  
                </style>
                <div class="page">
                    <!-- Cabeçalho -->
                    <div class="row">
                        <div class="col-12 text-center">
                            <h2>Relatório Resumido de Atendimentos</h2>
                        </div>
                    </div>
                    
                    <!-- Informações dos Filtros -->
                    <div class="row mt-3 mb-3">
                        <div class="col-12">
                            <table class="table table-sm table-borderless">
                                <tbody>
                                    <tr>
                                        <td><strong>Período:</strong></td>
                                        <td>
                                            <t t-set="date_start_str" t-value="data.get('date_start') or ''" />
                                            <t t-set="date_end_str" t-value="data.get('date_end') or ''" />
                                            <t t-if="date_start_str">
                                                <t t-esc="date_start_str" />
                                            </t>
                                            <t t-if="date_start_str and date_end_str"> até </t>
                                            <t t-if="date_end_str">
                                                <t t-esc="date_end_str" />
                                            </t>
                                        </td>
                                    </tr>
                                    <tr t-if="data.get('equipment_id')">
                                        <td><strong>Equipamento:</strong></td>
                                        <td>
                                            <t t-set="equipment" t-value="env['engc.equipment'].browse([data.get('equipment_id')])" />
                                            <t t-if="equipment.exists()">
                                                <span t-field="equipment.name" />
                                            </t>
                                        </td>
                                    </tr>
                                    <tr t-if="data.get('state')">
                                        <td><strong>Status:</strong></td>
                                        <td>
                                            <t t-set="state_labels" t-value="{'draft': 'Criado', 'done': 'Concluído', 'cancel': 'Cancelado'}" />
                                            <t t-esc="state_labels.get(data.get('state'), data.get('state'))" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total de Relatórios:</strong></td>
                                        <td>
                                            <t t-esc="len(docs)" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tabela de Relatórios Agrupados por Equipamento e OS -->
                    <div class="row">
                        <div class="col-12">
                            <t t-set="state_labels" t-value="{'draft': 'Criado', 'done': 'Concluído', 'cancel': 'Cancelado'}" />
                            <t t-set="report_type_labels" t-value="{'orcamento': 'Orçamento', 'manutencao': 'Manutenção', 'instalacao': 'Instalação', 'treinamento': 'Treinamento', 'calibracao': 'Calibração', 'qualificacao': 'Qualificação'}" />
                            
                            <!-- Mapeamento de cores para status do relatório -->
                            <t t-set="relatorio_colors" t-value="{'done': '#28a745', 'cancel': '#dc3545', 'draft': '#6c757d'}" />
                            
                            <!-- Mapeamento de cores para status da OS -->
                            <t t-set="os_colors" t-value="{'done': '#28a745', 'cancel': '#dc3545', 'reproved': '#dc3545', 'under_repair': '#ffc107', 'execution_ready': '#ffc107', 'pause_repair': '#ffc107', 'wait_parts': '#17a2b8', 'wait_authorization': '#17a2b8', 'under_budget': '#17a2b8', 'pause_budget': '#17a2b8', 'draft': '#6c757d'}" />
                            
                            <!-- Loop por Equipamento -->
                            <t t-foreach="grouped_data" t-as="equipment_group">
                                <!-- Quebra de página antes de cada equipamento (exceto o primeiro) -->
                                <t t-if="equipment_group_index > 0">
                                    <div style="page-break-before: always;"></div>
                                </t>
                                
                                <!-- Cabeçalho do Equipamento -->
                                <div class="mt-4 mb-3">
                                    <h4 class="bg-primary text-white" style="padding: 0.75rem; margin-bottom: 0; border-radius: 0.25rem;">
                                        <strong>Equipamento: <t t-esc="equipment_group['equipment_name']" /></strong>
                                    </h4>
                                </div>
                                
                                <!-- Loop por OS dentro do Equipamento -->
                                <t t-foreach="equipment_group['os_list']" t-as="os_group">
                                    <!-- Divisão entre OSs (exceto a primeira) -->
                                    <t t-if="os_group_index > 0">
                                        <hr class="border-secondary my-4" style="border-top-width: 2px;" />
                                    </t>
                                    
                                    <!-- Cabeçalho da OS -->
                                    <div class="mt-3 mb-2">
                                        <h5 class="bg-light border-start border-primary border-3" style="padding: 0.5rem 0.75rem; margin-bottom: 0;">
                                            <strong>Ordem de Serviço: <t t-esc="os_group['os_name']" /></strong>
                                        </h5>
                                    </div>
                                    
                                    <!-- Informações da OS -->
                                    <div class="mb-3 bg-light border-start border-primary border-4" style="padding: 0.75rem;">
                                        <table class="table table-sm table-borderless mb-2">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 20%;"><strong>Solicitante:</strong></td>
                                                    <td><t t-esc="os_group.get('solicitante', '')" /></td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Data Requisição:</strong></td>
                                                    <td>
                                                        <t t-if="os_group.get('date_request_formatted')">
                                                            <t t-esc="os_group.get('date_request_formatted', '')" />
                                                        </t>
                                                        <t t-if="not os_group.get('date_request_formatted')">-</t>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Tipo de Manutenção:</strong></td>
                                                    <td><t t-esc="os_group.get('maintenance_type_label', '')" /></td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Status da OS:</strong></td>
                                                    <td>
                                                        <t t-set="os_state" t-value="os_group.get('os_state', '')" />
                                                        <t t-if="os_state">
                                                            <t t-set="os_color" t-value="os_colors.get(os_state, '#6c757d')" />
                                                            <span t-attf-style="color: #{os_color}; font-weight: bold;">
                                                                <t t-esc="os_group.get('os_state_label', '')" />
                                                            </span>
                                                        </t>
                                                        <t t-if="not os_state">-</t>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Tempo de Execução:</strong></td>
                                                    <td><t t-esc="'%.2f' % os_group.get('time_execution', 0.0)" /> h</td>
                                                </tr>
                                                <tr t-if="os_group.get('problem_description')">
                                                    <td><strong>Descrição do Chamado:</strong></td>
                                                    <td><t t-esc="os_group.get('problem_description', '')" /></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        
                                        <!-- Peças Requisitadas -->
                                        <t t-if="os_group.get('request_parts') and len(os_group['request_parts']) > 0">
                                            <h6 style="margin-top: 1rem; margin-bottom: 0.5rem;"><strong>Peças Requisitadas:</strong></h6>
                                            <table class="table table-sm table-bordered mb-2">
                                                <thead>
                                                    <tr>
                                                        <th><strong>Código</strong></th>
                                                        <th><strong>Descrição</strong></th>
                                                        <th class="text-right"><strong>Quantidade</strong></th>
                                                        <th><strong>Status</strong></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="os_group['request_parts']" t-as="part">
                                                        <tr>
                                                            <td><t t-esc="part.get('product_code', '')" /></td>
                                                            <td><t t-esc="part.get('product_name', '')" /></td>
                                                            <td class="text-right">
                                                                <t t-esc="'%.2f' % part.get('quantity', 0.0)" />
                                                                <t t-if="part.get('uom')"> <t t-esc="part.get('uom', '')" /></t>
                                                            </td>
                                                            <td><t t-esc="part.get('state_label', '')" /></td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </t>
                                        
                                        <!-- Peças Aplicadas -->
                                        <t t-if="os_group.get('applied_parts') and len(os_group['applied_parts']) > 0">
                                            <h6 style="margin-top: 1rem; margin-bottom: 0.5rem;"><strong>Peças Aplicadas:</strong></h6>
                                            <table class="table table-sm table-bordered mb-2">
                                                <thead>
                                                    <tr>
                                                        <th><strong>Código</strong></th>
                                                        <th><strong>Descrição</strong></th>
                                                        <th class="text-right"><strong>Quantidade</strong></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="os_group['applied_parts']" t-as="part">
                                                        <tr>
                                                            <td><t t-esc="part.get('product_code', '')" /></td>
                                                            <td><t t-esc="part.get('product_name', '')" /></td>
                                                            <td class="text-right">
                                                                <t t-esc="'%.2f' % part.get('quantity', 0.0)" />
                                                                <t t-if="part.get('uom')"> <t t-esc="part.get('uom', '')" /></t>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </t>
                                    </div>
                                    
                                    <!-- Tabela de Relatórios da OS -->
                                    <h6 style="margin-top: 1rem; margin-bottom: 0.5rem;"><strong>Relatórios de Atendimento:</strong></h6>
                                    <table class="table table-sm table-bordered table-striped mb-4">
                                        <thead>
                                            <tr>
                                                <th><strong>Nº Relatório</strong></th>
                                                <th><strong>Tipo</strong></th>
                                                <th><strong>Data Início</strong></th>
                                                <th><strong>Data Fim</strong></th>
                                                <th class="text-right"><strong>Tempo (h)</strong></th>
                                                <th><strong>Status</strong></th>
                                                <th><strong>Técnicos</strong></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="os_group['relatorios']" t-as="relatorio_info">
                                                <t t-set="relatorio" t-value="relatorio_info['relatorio']" />
                                                <tr>
                                                    <td>
                                                        <span t-field="relatorio.name" />
                                                    </td>
                                                    <td>
                                                        <t t-esc="report_type_labels.get(relatorio.report_type, relatorio.report_type)" />
                                                    </td>
                                                    <td>
                                                        <span t-field="relatorio.data_atendimento" t-options="{'widget': 'datetime'}" />
                                                    </td>
                                                    <td>
                                                        <span t-field="relatorio.data_fim_atendimento" t-options="{'widget': 'datetime'}" />
                                                    </td>
                                                    <td class="text-right">
                                                        <t t-esc="'%.2f' % relatorio.time_execution" />
                                                    </td>
                                                    <td>
                                                        <t t-set="rel_state" t-value="relatorio.state or ''" />
                                                        <t t-if="rel_state">
                                                            <t t-set="rel_color" t-value="relatorio_colors.get(rel_state, '#6c757d')" />
                                                            <span t-attf-style="color: #{rel_color}; font-weight: bold;">
                                                                <t t-esc="state_labels.get(rel_state, rel_state)" />
                                                            </span>
                                                        </t>
                                                        <t t-if="not rel_state">-</t>
                                                    </td>
                                                    <td>
                                                        <t t-set="tecnicos_list" t-value="relatorio.technicians.mapped('name')" />
                                                        <t t-esc="', '.join(tecnicos_list)" />
                                                    </td>
                                                </tr>
                                                <!-- Informações detalhadas do relatório -->
                                                <tr class="bg-light">
                                                    <td colspan="7" style="padding: 0.75rem;">
                                                        <div style="font-size: 0.9em;">
                                                            <t t-if="relatorio_info.get('fault_description')">
                                                                <p style="margin-bottom: 0.5rem;">
                                                                    <strong>Descrição do Defeito:</strong><br/>
                                                                    <t t-esc="relatorio_info.get('fault_description', '')" />
                                                                </p>
                                                            </t>
                                                            <t t-if="relatorio_info.get('service_summary')">
                                                                <p style="margin-bottom: 0.5rem;">
                                                                    <strong>Resumo do Atendimento:</strong><br/>
                                                                    <t t-esc="relatorio_info.get('service_summary', '')" />
                                                                </p>
                                                            </t>
                                                            <t t-if="relatorio_info.get('pendency')">
                                                                <p style="margin-bottom: 0.5rem;">
                                                                    <strong>Pendência:</strong><br/>
                                                                    <t t-esc="relatorio_info.get('pendency', '')" />
                                                                </p>
                                                            </t>
                                                            <t t-if="relatorio_info.get('state_equipment_label')">
                                                                <p style="margin-bottom: 0;">
                                                                    <strong>Estado do Equipamento:</strong>
                                                                    <t t-esc="relatorio_info.get('state_equipment_label', '')" />
                                                                </p>
                                                            </t>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </t>
                                
                                <!-- Resumo do Equipamento -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5>Resumo - <t t-esc="equipment_group['equipment_name']" /></h5>
                                        
                                        <!-- Resumo de Status das OSs -->
                                        <h6 style="margin-bottom: 0.75rem;"><strong>Resumo de Ordens de Serviço:</strong></h6>
                                        <table class="table table-sm table-bordered mb-3">
                                            <thead>
                                                <tr>
                                                    <th><strong>Status</strong></th>
                                                    <th class="text-right"><strong>Quantidade</strong></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-set="os_summary" t-value="equipment_group.get('os_summary', {})" />
                                                <tr t-if="os_summary.get('draft', 0) > 0">
                                                    <td>Criada</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('draft', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('under_budget', 0) > 0">
                                                    <td>Em Orçamento</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('under_budget', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('pause_budget', 0) > 0">
                                                    <td>Orçamento Pausado</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('pause_budget', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('wait_authorization', 0) > 0">
                                                    <td>Esperando aprovação</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('wait_authorization', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('wait_parts', 0) > 0">
                                                    <td>Esperando peças</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('wait_parts', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('execution_ready', 0) > 0">
                                                    <td>Pronta para Execução</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('execution_ready', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('under_repair', 0) > 0">
                                                    <td>Em execução</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('under_repair', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('pause_repair', 0) > 0">
                                                    <td>Execução Pausada</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('pause_repair', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('reproved', 0) > 0">
                                                    <td>Reprovada</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('reproved', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('done', 0) > 0">
                                                    <td>Concluída</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('done', 0)" />
                                                    </td>
                                                </tr>
                                                <tr t-if="os_summary.get('cancel', 0) > 0">
                                                    <td>Cancelada</td>
                                                    <td class="text-right">
                                                        <t t-esc="os_summary.get('cancel', 0)" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Total</strong></td>
                                                    <td class="text-right">
                                                        <strong><t t-esc="os_summary.get('total_os_count', 0)" /></strong>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        
                                        <!-- Resumo de Horas e Disponibilidade -->
                                        <div class="mb-3">
                                            <h6 style="margin-bottom: 0.75rem;"><strong>Disponibilidade do Equipamento:</strong></h6>
                                            <table class="table table-sm table-bordered mb-2">
                                                <tbody>
                                                    <tr>
                                                        <td style="width: 50%;"><strong>Tempo de Manutenção:</strong></td>
                                                        <td class="text-right">
                                                            <t t-esc="'%.2f' % equipment_group['summary'].get('total_maintenance_time', 0.0)" /> h
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Tempo Parado:</strong></td>
                                                        <td class="text-right">
                                                            <t t-esc="'%.2f' % equipment_group['summary'].get('total_downtime', 0.0)" /> h
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Tempo Total Indisponível:</strong></td>
                                                        <td class="text-right">
                                                            <t t-esc="'%.2f' % equipment_group['summary'].get('total_unavailable_time', 0.0)" /> h
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Período Total:</strong></td>
                                                        <td class="text-right">
                                                            <t t-esc="'%.2f' % equipment_group['summary'].get('period_total_hours', 0.0)" /> h
                                                        </td>
                                                    </tr>
                                                    <tr class="bg-light">
                                                        <td><strong>Disponibilidade:</strong></td>
                                                        <td class="text-right">
                                                            <strong><t t-esc="'%.2f' % equipment_group['summary'].get('availability_percent', 0.0)" />%</strong>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Resumo de Peças Aplicadas -->
                                        <t t-if="equipment_group.get('applied_parts_summary') and len(equipment_group['applied_parts_summary']) > 0">
                                            <h6 style="margin-top: 1rem; margin-bottom: 0.5rem;"><strong>Peças Aplicadas - <t t-esc="equipment_group['equipment_name']" />:</strong></h6>
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th><strong>Código</strong></th>
                                                        <th><strong>Descrição</strong></th>
                                                        <th class="text-right"><strong>Quantidade Total</strong></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <t t-foreach="equipment_group['applied_parts_summary']" t-as="part">
                                                        <tr>
                                                            <td><t t-esc="part.get('product_code', '')" /></td>
                                                            <td><t t-esc="part.get('product_name', '')" /></td>
                                                            <td class="text-right">
                                                                <t t-esc="'%.2f' % part.get('total_quantity', 0.0)" />
                                                                <t t-if="part.get('uom')"> <t t-esc="part.get('uom', '')" /></t>
                                                            </td>
                                                        </tr>
                                                    </t>
                                                </tbody>
                                            </table>
                                        </t>
                                    </div>
                                </div>
                                
                                <hr class="border-secondary" style="border-top-width: 2px; margin: 2rem 0;" />
                            </t>
                        </div>
                    </div>

                    <!-- Resumo Geral Total -->
                    <div style="page-break-before: always;"></div>
                    <div class="row mt-4">
                        <div class="col-12">
                            <h3 class="bg-primary text-white" style="padding: 0.75rem; margin-bottom: 1rem;">
                                <strong>Resumo Geral</strong>
                            </h3>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th><strong>Status</strong></th>
                                        <th class="text-right"><strong>Quantidade</strong></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Criado</td>
                                        <td class="text-right">
                                            <t t-esc="total_summary['draft']" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Concluído</td>
                                        <td class="text-right">
                                            <t t-esc="total_summary['done']" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Cancelado</td>
                                        <td class="text-right">
                                            <t t-esc="total_summary['cancel']" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total</strong></td>
                                        <td class="text-right">
                                            <strong><t t-esc="total_summary['total_count']" /></strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <p>
                                <strong>Tempo Total de Atendimento no período:</strong>
                                <t t-esc="'%.2f' % total_summary['total_time']" /> h
                            </p>
                        </div>
                    </div>

                    <div class="oe_structure" />
                </div>
            </t>
        </t>
    </template>
</odoo>

